import{k as oe,r as c,X as se,Y as ne,o as M,h as ae,n as re,g as ie,Z as ue,$ as T,a0 as le,a1 as ce,D as de,a2 as fe,_ as H,x as J,S as K,y as p,d as me,a3 as pe,c as ve,a4 as ge,u as ye,f as l,t as S,a5 as he,a6 as U,a7 as A,V as P,a8 as be,a9 as z,aa as j,z as N,ab as Ce,ac as Q,ad as we,ae as _e,af as xe,ag as Ie,ah as Se,ai as Be,aj as Fe,ak as Ae}from"./index.10c8caa7.js";import{u as ke}from"./AlertDialog.bb596bca.js";var De=oe({name:"QForm",props:{autofocus:Boolean,noErrorFocus:Boolean,noResetFocus:Boolean,greedy:Boolean,onSubmit:Function},emits:["reset","validationSuccess","validationError"],setup(s,{slots:a,emit:i}){const d=ie(),v=c(null);let f=0;const g=[];function w(o){const y=typeof o=="boolean"?o:s.noErrorFocus!==!0,F=++f,V=(r,u)=>{i(`validation${r===!0?"Success":"Error"}`,u)},q=r=>{const u=r.validate();return typeof u.then=="function"?u.then(h=>({valid:h,comp:r}),h=>({valid:!1,comp:r,err:h})):Promise.resolve({valid:u,comp:r})};return(s.greedy===!0?Promise.all(g.map(q)).then(r=>r.filter(u=>u.valid!==!0)):g.reduce((r,u)=>r.then(()=>q(u).then(h=>{if(h.valid===!1)return Promise.reject(h)})),Promise.resolve()).catch(r=>[r])).then(r=>{if(r===void 0||r.length===0)return F===f&&V(!0),!0;if(F===f){const{comp:u,err:h}=r[0];if(h!==void 0&&console.error(h),V(!1,u),y===!0){const k=r.find(({comp:$})=>typeof $.focus=="function"&&ue($.$)===!1);k!==void 0&&k.comp.focus()}}return!1})}function _(){f++,g.forEach(o=>{typeof o.resetValidation=="function"&&o.resetValidation()})}function m(o){o!==void 0&&T(o);const y=f+1;w().then(F=>{y===f&&F===!0&&(s.onSubmit!==void 0?i("submit",o):o!==void 0&&o.target!==void 0&&typeof o.target.submit=="function"&&o.target.submit())})}function x(o){o!==void 0&&T(o),i("reset"),le(()=>{_(),s.autofocus===!0&&s.noResetFocus!==!0&&I()})}function I(){ce(()=>{if(v.value===null)return;const o=v.value.querySelector("[autofocus][tabindex], [data-autofocus][tabindex]")||v.value.querySelector("[autofocus] [tabindex], [data-autofocus] [tabindex]")||v.value.querySelector("[autofocus], [data-autofocus]")||Array.prototype.find.call(v.value.querySelectorAll("[tabindex]"),y=>y.tabIndex!==-1);o!=null&&o.focus({preventScroll:!0})})}de(fe,{bindComponent(o){g.push(o)},unbindComponent(o){const y=g.indexOf(o);y!==-1&&g.splice(y,1)}});let B=!1;return se(()=>{B=!0}),ne(()=>{B===!0&&s.autofocus===!0&&I()}),M(()=>{s.autofocus===!0&&I()}),Object.assign(d.proxy,{validate:w,resetValidation:_,submit:m,reset:x,focus:I,getValidationComponents:()=>g}),()=>ae("form",{class:"q-form",ref:v,onSubmit:m,onReset:x},re(a.default))}}),L="/chi252525/assets/null-logo.2378859a.jpg";const Ee={},Ve={class:"ci-container"};function qe(s,a){return J(),K("div",Ve,a[0]||(a[0]=[p("div",{class:"ci-img img-blue"},null,-1),p("div",{class:"ci-img img-yellow"},null,-1),p("div",{class:"ci-img img-pink"},null,-1)]))}var $e=H(Ee,[["render",qe],["__scopeId","data-v-4f340e0c"]]);const O={require:s=>a=>a?!0:`${s} \u70BA\u5FC5\u586B`,phoneNumber:s=>/^[0-9]*$/.test(s)?!0:"\u8ACB\u8F38\u5165\u6709\u6548\u7684\u96FB\u8A71\u865F\u78BC",phoneExtension:s=>/^[0-9]{1,5}$/.test(s)?!0:"\u8ACB\u8F38\u5165\u6709\u6548\u7684\u96FB\u8A71\u865F\u78BC",validateLogin:s=>s&&s.length==10?!0:"\u5FC5\u586B\uFF0C\u8ACB\u78BA\u8A8D\u683C\u5F0F\u61C9\u70BA 0987654321"};class E extends Error{}E.prototype.name="InvalidTokenError";function Pe(s){return decodeURIComponent(atob(s).replace(/(.)/g,(a,i)=>{let d=i.charCodeAt(0).toString(16).toUpperCase();return d.length<2&&(d="0"+d),"%"+d}))}function Ne(s){let a=s.replace(/-/g,"+").replace(/_/g,"/");switch(a.length%4){case 0:break;case 2:a+="==";break;case 3:a+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return Pe(a)}catch{return atob(a)}}function Re(s,a){if(typeof s!="string")throw new E("Invalid token specified: must be a string");a||(a={});const i=a.header===!0?0:1,d=s.split(".")[i];if(typeof d!="string")throw new E(`Invalid token specified: missing part #${i+1}`);let v;try{v=Ne(d)}catch(f){throw new E(`Invalid token specified: invalid base64 for part #${i+1} (${f.message})`)}try{return JSON.parse(v)}catch(f){throw new E(`Invalid token specified: invalid json for part #${i+1} (${f.message})`)}}const Te="0.0.1";const Ue=["src"],ze={class:"text-center textSize-h2"},je={class:"row justify-start items-center q-mt-md"},Qe={class:"row no-wrap justify-between items-center q-mt-lg"},Le={class:"row justify-center items-center container-fet"},Oe={class:"text-info"},Me=me({__name:"Login",setup(s,{expose:a}){const i=pe(),d=c(""),v=ve(()=>d.value?d.value:L),f=c(""),g=ge(),w=c(!0),_=c(!0),m=c(""),x=c(""),I=c(!1),B=c(!1),o=c(!1),{showNoticeMessage:y,confirmMessage:F}=ke(),V=ye(),q=async()=>{i.user.accessToken&&await V.replace("/home")};async function R(){o.value=!0;const n=localStorage.getItem("orgId");if(m.value!==""&&I.value!==null&&n){const e=new URLSearchParams;e.append("mobile",m.value);try{const t=await xe(e.toString(),n)}catch(t){Ie(t)&&t.response&&(t.response.status===429?F({type:"negative",deleteConfirmStatus:!0,message:"\u5BC6\u78BC\u5DF2\u767C\u9001\uFF0C\u5982\u679C\u6C92\u6709\u6536\u5230\uFF0C\u8ACB\u7A0D\u5019\u518D\u91CD\u65B0\u53D6\u5F97",content:""}):console.log(t))}}o.value=!1}const r=c(!1),u=c(!1),h=c(!1),k=c("");async function $(n){const e=localStorage.getItem("orgId");try{if(e&&!u.value)return await Se(n,e);if(e&&u.value&&k.value)return await Be({idNumber:k.value},e)}catch(t){throw console.error("Error during login:",t),t}}async function X(){try{return await Fe()}catch(n){throw console.error("Error fetching permissionsAuth:",n),n}}async function Y(){try{return await Ae()}catch(n){throw console.error("Error fetching permissionsInfo:",n),n}}async function Z(n){try{const e=await $(n);if(console.log("loginResponse",e),(e==null?void 0:e.status)===200){const t=Re(e.data.accessToken);i.updateUserInfo({...e.data}),i.updateUserInfo({...t});const b=await X(),C=await Y();return{loginData:e,permissionsAuth:b,permissionsInfo:C}}else throw new Error("Login failed")}catch(e){throw console.error("Error in login and fetch process:",e),e}}function G(n,e,t){const b=new Date;b.setTime(b.getTime()+t*24*60*60*1e3);let C="expires="+b.toUTCString();document.cookie=n+"="+e+";"+C+";path=/"}const W=async()=>{r.value=!0,B.value&&G("CloudHIS-account",m.value,7);try{const{loginData:n,permissionsAuth:e,permissionsInfo:t}=await Z({username:m.value,password:x.value}),C={employee:{organizationId:t.data.employee.organizationId,no:t.data.employee.no,chName:t.data.employee.chName,enName:t.data.employee.enName,title:t.data.employee.title}};i.updateUserInfo(C);const D={permissionsRoles:e.data.roles,permissionsAPI:e.data.permissions};i.updateUserInfo({...D}),n.status===200&&e.status==200&&t.status==200&&(y({type:"positive",message:"\u767B\u5165\u6210\u529F",content:""}),q())}catch(n){y({type:"negative",message:"\u767B\u5165\u5931\u6557,\u8ACB\u91CD\u65B0\u767B\u5165",content:""}),console.error("Error in onSubmit:",n)}r.value=!1};function ee(){m.value="",x.value="",I.value=!1}function te(n){let e=n+"=",b=decodeURIComponent(document.cookie).split(";");for(let C=0;C<b.length;C++){let D=b[C].trim();if(D.indexOf(e)===0)return D.substring(e.length,D.length)}return""}return M(async()=>{m.value=te("CloudHIS-account"),window.history.replaceState(null,"",window.location.href)}),a({base64Image:d,clinicName:f}),(n,e)=>(J(),K("div",{class:P(["row justify-center items-center container",{"q-pa-md":A(g).screen.lt.md}]),align:"center"},[l($e),l(he,{class:"shadow-5 container-login"},{default:S(()=>[p("img",{src:v.value,style:{width:"72px",height:"67.62px"}},null,8,Ue),p("span",ze,U(f.value),1),l(be,null,{default:S(()=>[l(De,{class:"",onSubmit:W,onReset:ee},{default:S(()=>[p("div",{class:P(`row justify-between items-start ${A(g).screen.lt.md?"":"no-wrap"}`)},[l(z,{modelValue:m.value,"onUpdate:modelValue":e[1]||(e[1]=t=>m.value=t),type:w.value?"password":"text",class:"col-12 col-md-8 q-mr-sm q-mb-md textSize-16 is_require",outlined:"",clearable:"",label:"\u5E33\u865F",placeholder:"\u624B\u6A5F\u865F\u78BC",rules:[m.value||u.value?A(O).validateLogin:A(O).require("\u5E33\u865F")],"hide-bottom-space":""},{append:S(()=>[l(j,{name:w.value?"visibility_off":"visibility",class:"cursor-pointer",onClick:e[0]||(e[0]=t=>w.value=!w.value)},null,8,["name"])]),_:1},8,["modelValue","type","rules"]),l(N,{disable:o.value,class:"col-12 col-md-4 textSize-16",color:"primary",outline:"",label:"\u53D6\u5F97\u5BC6\u78BC",onClick:e[2]||(e[2]=t=>R())},null,8,["disable"])],2),l(z,{modelValue:x.value,"onUpdate:modelValue":e[4]||(e[4]=t=>x.value=t),type:_.value?"password":"text",class:P(["col-12 textSize-16 is_require",{"q-mt-md":A(g).screen.lt.md}]),outlined:"",clearable:"",label:"\u5BC6\u78BC",placeholder:"SMS OTP"},{append:S(()=>[l(j,{name:_.value?"visibility_off":"visibility",class:"cursor-pointer",onClick:e[3]||(e[3]=t=>_.value=!_.value)},null,8,["name"])]),_:1},8,["modelValue","type","class"]),p("div",je,[l(Ce,{modelValue:B.value,"onUpdate:modelValue":e[5]||(e[5]=t=>B.value=t),label:"\u8A18\u4F4F\u5E33\u865F",class:"textSize-16"},null,8,["modelValue"])]),p("div",Qe,[l(N,{outline:"",label:"\u6E05\u9664",type:"reset",color:"primary",class:"col-6 q-mr-sm textSize-16 guide-btn"}),l(N,{rounded:"",label:"\u767B\u5165",loading:h.value,type:"submit",color:"accent",class:"col-6 textSize-16 guide-btn"},{loading:S(()=>[l(Q),e[6]||(e[6]=we("\u3000\u7B49\u5F85\u9023\u7DDA..."))]),_:1},8,["loading"])])]),_:1})]),_:1}),l(_e,{showing:r.value},{default:S(()=>[l(Q,{size:"50px",color:"primary"})]),_:1},8,["showing"])]),_:1}),p("div",Le,[e[7]||(e[7]=p("img",{class:"q-mr-sm",src:L,alt:""},null,-1)),e[8]||(e[8]=p("span",{class:"text-info"},null,-1)),p("span",Oe,"(Version: "+U(A(Te))+")",1)])],2))}});var Ke=H(Me,[["__scopeId","data-v-1b0ceaa3"]]);export{Ke as default};
